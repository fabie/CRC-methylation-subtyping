---
title: "External Validation"
author: "Fabie Van Cappel"
date: "2025-11-22"
output: 
  pdf_document:
    latex_engine: xelatex
toc: true
number_sections: true
keep_tex: true
---



```{r}

################################################################################
# WEEK 6: EXTERNAL VALIDATION
################################################################################

# No additional libraries needed! Week 6 uses only base R functions:
# - read.csv(), write.csv(), merge() - data handling
# - table(), chisq.test(), fisher.test(), kruskal.test() - statistics
# - png(), barplot(), boxplot(), plot() - graphics

# Set working directory
# setwd() # your diretory path

# Set a seed for reproducibility (Fisher's exact uses simulation)
set.seed(12345)

# Create output directories
dir.create("04_External_Validation", recursive = TRUE, showWarnings = FALSE)
dir.create("04_External_Validation/plots", recursive = TRUE, showWarnings = FALSE)
dir.create("04_External_Validation/tables", recursive = TRUE, showWarnings = FALSE)

cat("Setup complete - ready for external validation!\n\n")

# Load cluster assignments
clusters_k3 <- read.csv("02_Clustering_Results/final_clusters_k3.csv")
clusters_292 <- read.csv("02_Clustering_Results/final_clusters_k3_unique_patients.csv")

# Check if duplicate samples were in same cluster
samples_per_patient <- table(clusters_k3$patient_id)
duplicate_patients <- names(samples_per_patient[samples_per_patient > 1])

cat("Checking duplicate sample consistency:\n")
cat("  Patients with multiple samples:", length(duplicate_patients), "\n\n")

# Create deduplicated dataset
clusters_k3 <- read.csv("02_Clustering_Results/final_clusters_k3.csv")
clusters_292 <- clusters_k3[!duplicated(clusters_k3$patient_id), ]

write.csv(clusters_292, "02_Clustering_Results/final_clusters_k3_unique_patients.csv", row.names = FALSE)

cat("Cluster distribution (292 patients):\n")
print(table(clusters_292$cluster))

print(table(clusters_292$cluster))


################################################################################
# STEP 1: Load Data
################################################################################

cat("Loading data...\n")

# Cluster assignments (292 unique patients)
clusters_292 <- read.csv("02_Clustering_Results/final_clusters_k3_unique_patients.csv")

# Mutation data
mutation_data <- read.csv("00_Raw_Data/01_Processed_Data/mutation_summary_292.csv")

# Clinical data
clinical_data <- read.csv("00_Raw_Data/01_Processed_Data/clinical_cohort_292.csv")

cat("  Clusters: ", nrow(clusters_292), "patients\n")
cat("  Mutations: ", nrow(mutation_data), "patients\n")
cat("  Clinical: ", nrow(clinical_data), "patients\n\n")

################################################################################
# STEP 2: Merge Data
################################################################################

# Start with clusters
merged_data <- clusters_292

# Add mutation data
merged_data <- merge(merged_data, mutation_data, by = "patient_id", all.x = TRUE)

# Add clinical data
clinical_subset <- clinical_data[, c("submitter_id", "age_at_diagnosis", 
                                      "gender", "vital_status", "ajcc_pathologic_stage",
                                      "days_to_death", "days_to_last_follow_up",
                                      "tumor_grade", "primary_diagnosis",
                                      "site_of_resection_or_biopsy")]
names(clinical_subset)[1] <- "patient_id"

merged_data <- merge(merged_data, clinical_subset, by = "patient_id", all.x = TRUE)

cat("  Merged dataset:", nrow(merged_data), "patients with", ncol(merged_data), "variables\n\n")

# Save merged dataset
write.csv(merged_data, "04_External_Validation/merged_clusters_with_features.csv", row.names = FALSE)

# Load it
merged_data <- read.csv("04_External_Validation/merged_clusters_with_features.csv")
  
# Check contents
cat("  Rows:", nrow(merged_data), "\n")
cat("  Columns:", ncol(merged_data), "\n")
cat("  Column names:", paste(head(names(merged_data), 10), collapse=", "), "...\n")

# Load the file
merged_data <- read.csv("04_External_Validation/merged_clusters_with_features.csv")

cat("Checking for missing values...\n\n")

# Overall missing count
total_cells <- nrow(merged_data) * ncol(merged_data)
total_missing <- sum(is.na(merged_data))
cat("Total cells:", total_cells, "\n")
cat("Total missing:", total_missing, "(", round(100*total_missing/total_cells, 1), "%)\n\n")

# Missing values by column
cat("Missing values by column:\n")
cat("â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ \n")
missing_by_col <- colSums(is.na(merged_data))
missing_by_col <- missing_by_col[missing_by_col > 0]  # Only show columns with missing

if(length(missing_by_col) > 0) {
  for(col_name in names(missing_by_col)) {
    pct_missing <- 100 * missing_by_col[col_name] / nrow(merged_data)
    cat(sprintf("%-30s: %3d missing (%.1f%%)\n", 
                col_name, missing_by_col[col_name], pct_missing))
  }
} else {
  cat(" âœ…  No missing values!\n")
}

cat("\n")

# Check key variables specifics
cat("Key variables for analysis:\n")
cat("â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ \n")
key_vars <- c("patient_id", "cluster", "has_lynch_core", "has_braf", 
              "has_msi_related", "has_kras", "age_at_diagnosis", 
              "gender", "vital_status")

for(var in key_vars) {
  if(var %in% names(merged_data)) {
    n_missing <- sum(is.na(merged_data[[var]]))
    pct_missing <- 100 * n_missing / nrow(merged_data)
    status <- ifelse(n_missing == 0, "âœ“", "âš ")
    cat(sprintf("%s %-25s: %3d missing (%.1f%%)\n", 
                status, var, n_missing, pct_missing))
  }
}

cat("\n")

# Check how many samples have complete data for core analysis
complete_molecular <- complete.cases(merged_data[, c("cluster", "has_lynch_core", 
                                                       "has_braf", "has_msi_related")])
cat("Samples with complete molecular data:", sum(complete_molecular), 
    "out of", nrow(merged_data), "\n")

complete_clinical <- complete.cases(merged_data[, c("cluster", "age_at_diagnosis", 
                                                      "gender")])
cat("Samples with complete clinical data:", sum(complete_clinical), 
    "out of", nrow(merged_data), "\n")

cat("We have 98.6% complete dataset for clinical data. Only 4 patients with missing age. That is very good")

################################################################################
# STEP 3: Molecular Marker Associations
################################################################################


writeLines(c(
  "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
  "â•‘   MOLECULAR MARKER ASSOCIATIONS        â•‘",
  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
))

# Function for association testing
test_association <- function(data, feature, feature_name) {
  cat(feature_name, ":\n", sep="")
  cat("â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ \n")
  
  # Create contingency table
  contingency <- table(data$cluster, data[[feature]])
  print(contingency)
  
  # Choose test
  if(min(contingency) >= 5) {
    test_result <- chisq.test(contingency)
    test_name <- "Chi-square"
  } else {
    test_result <- fisher.test(contingency, simulate.p.value = TRUE)
    test_name <- "Fisher's exact"
  }
  
  cat("\n", test_name, " test: p = ", format.pval(test_result$p.value), "\n", sep="")
  
  # Percentages by cluster
  cat("\nPercentages by cluster:\n")
  pct_table <- prop.table(contingency, margin = 1) * 100
  print(round(pct_table, 1))
  cat("\n")
  
  return(list(
    test = test_name,
    p_value = test_result$p.value,
    contingency = contingency,
    percentages = pct_table
  ))
}

# Test all markers
lynch_result <- test_association(merged_data, "has_lynch_core", "Lynch Syndrome Mutations")
braf_result <- test_association(merged_data, "has_braf", "BRAF Mutations")
msi_result <- test_association(merged_data, "has_msi_related", "MSI-High Status")
kras_result <- test_association(merged_data, "has_kras", "KRAS Mutations")

################################################################################
# STEP 4: Create a Summary Table (ref. results from STEP 3)
################################################################################

summary_table <- data.frame(
  Feature = c("Lynch mutations", "BRAF mutations", "MSI-High", "KRAS mutations"),
  Overall_N = c(
    sum(merged_data$has_lynch_core, na.rm = TRUE),
    sum(merged_data$has_braf, na.rm = TRUE),
    sum(merged_data$has_msi_related, na.rm = TRUE),
    sum(merged_data$has_kras, na.rm = TRUE)
  ),
  Overall_Pct = round(c(
    100 * mean(merged_data$has_lynch_core, na.rm = TRUE),
    100 * mean(merged_data$has_braf, na.rm = TRUE),
    100 * mean(merged_data$has_msi_related, na.rm = TRUE),
    100 * mean(merged_data$has_kras, na.rm = TRUE)
  ), 1)
)

# Cluster-specific percentages
for(cl in 1:3) {
  cluster_data <- merged_data[merged_data$cluster == cl, ]
  summary_table[[paste0("Cluster", cl, "_Pct")]] <- round(c(
    100 * mean(cluster_data$has_lynch_core, na.rm = TRUE),
    100 * mean(cluster_data$has_braf, na.rm = TRUE),
    100 * mean(cluster_data$has_msi_related, na.rm = TRUE),
    100 * mean(cluster_data$has_kras, na.rm = TRUE)
  ), 1)
}

# P-values
summary_table$P_value <- format.pval(c(
  lynch_result$p_value,
  braf_result$p_value,
  msi_result$p_value,
  kras_result$p_value
), digits = 3)

print(summary_table)
cat("\n")

write.csv(summary_table, "04_External_Validation/tables/molecular_markers_by_cluster.csv", row.names = FALSE)


################################################################################
# STEP 5: Visualization - Molecular Markers
################################################################################

cat("Create molecular marker visualizations...\n")

png("04_External_Validation/plots/molecular_markers_by_cluster.png",
    width = 14, height = 10, units = "in", res = 300)

par(mfrow = c(2, 2), mar = c(5, 5, 4, 2))

plot_marker <- function(data, marker, title, p_val) {
  contingency <- table(data$cluster, data[[marker]])
  pct <- prop.table(contingency, margin = 1) * 100
  
  barplot(t(pct),
          beside = TRUE,
          col = c("lightgray", "#009E73"),
          names.arg = paste0("Cluster ", 1:3),
          ylab = "Percentage (%)",
          main = paste0(title, "\n(p ", format.pval(p_val, digits = 2), ")"),
          ylim = c(0, max(pct) * 1.3),
          border = "black",
          las = 1)
  
  legend("topright", 
         legend = c("Negative/Wild-type", "Positive/Mutated"),
         fill = c("lightgray", "#009E73"),
         border = "black")
  
  # Add counts
  for(i in 1:3) {
    n_pos <- contingency[i, "TRUE"]
    n_tot <- sum(contingency[i, ])
    text((i-1)*3 + 2, pct[i, "TRUE"] + max(pct) * 0.1, 
         paste0(n_pos, "/", n_tot),
         font = 2, cex = 1)
  }
}

plot_marker(merged_data, "has_lynch_core", "Lynch Mutations", lynch_result$p_value)
plot_marker(merged_data, "has_braf", "BRAF Mutations", braf_result$p_value)
plot_marker(merged_data, "has_msi_related", "MSI-High", msi_result$p_value)
plot_marker(merged_data, "has_kras", "KRAS Mutations", kras_result$p_value)

par(mfrow = c(1, 1))
dev.off()

cat("âœ…  Molecular marker plots saved\n\n")

################################################################################
# STEP 6: Clinical Features
################################################################################

writeLines(c(
  "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
  "â•‘   CLINICAL FEATURE ASSOCIATIONS  (gender, age, stage)      â•‘",
  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
))

# Age
cat("Age at Diagnosis:\n")
cat("â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ \n")
merged_data$age_years <- merged_data$age_at_diagnosis / 365.25

for(cl in 1:3) {
  age_subset <- merged_data$age_years[merged_data$cluster == cl]
  cat("Cluster", cl, ": Mean =", round(mean(age_subset, na.rm = TRUE), 1),
      "years (SD =", round(sd(age_subset, na.rm = TRUE), 1), ")\n")
}

age_test <- kruskal.test(age_years ~ cluster, data = merged_data)
cat("Kruskal-Wallis test: p =", format.pval(age_test$p.value), "\n\n")


# Gender
cat("Gender:\n")
cat("â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ \n")
gender_table <- table(merged_data$cluster, merged_data$gender)
print(gender_table)

cat("\nPercentages:\n")
gender_pct <- prop.table(gender_table, margin = 1) * 100
print(round(gender_pct, 1))

# Use Fisher's exact test (instead of chi-square)
gender_test <- fisher.test(gender_table, simulate.p.value = TRUE)
cat("Fisher's exact test: p =", format.pval(gender_test$p.value), "\n\n")

# Stage
cat("AJCC Pathologic Stage:\n")
cat("â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ â‰ \n")
merged_data$stage_simple <- gsub("[ABC]$", "", merged_data$ajcc_pathologic_stage)
stage_table <- table(merged_data$cluster, merged_data$stage_simple)
print(stage_table)
cat("\nPercentages:\n")
print(round(prop.table(stage_table, margin = 1) * 100, 1))

if(min(stage_table) >= 5) {
  stage_test <- chisq.test(stage_table)
  cat("Chi-square test: p =", format.pval(stage_test$p.value), "\n\n")
} else {
  stage_test <- fisher.test(stage_table, simulate.p.value = TRUE)
  cat("Fisher's exact test: p =", format.pval(stage_test$p.value), "\n\n")
}

################################################################################
# Table 1: Clinical Features Summary
################################################################################

clinical_summary <- data.frame(
  Feature = c("Age at Diagnosis (years)", 
              "Gender (% Male)", 
              "Stage I (%)", 
              "Stage II (%)", 
              "Stage III (%)", 
              "Stage IV (%)"),
  
  Cluster1 = c("61.2 Â± 13.5","51.5","7.4","37.9","29.5","25.3"),
  
  Cluster2 = c("69.4 Â± 12.7","50.0","21.2","43.9","28.8","6.1"),
  
  Cluster3 = c("67.1 Â± 12.3","55.3","18.5","38.7","31.9","10.9"),
  
  P_Value = c("8.23e-05","0.540","0.0065","0.0065","0.0065","0.0065"),
  
  Significance = c("***", "ns", "**", "**", "**", "**"),
  
  Interpretation = c(
    "Cluster 2 significantly older",
    "Balanced across clusters",
    "C2 has most early-stage",
    "Similar across clusters",
    "Similar across clusters",
    "C1 has most advanced disease"
  )
)

print(clinical_summary)

write.csv(clinical_summary, 
          "04_External_Validation/tables/clinical_features_summary.csv",
          row.names = FALSE)

cat("âœ“ Clinical features summary saved\n")

################################################################################
# Table 2: Stage Distribution (Wide Format)
################################################################################

stage_dist_ppt <- data.frame(
  Cluster = c("Cluster 1 (n=95)", "Cluster 2 (n=66)", "Cluster 3 (n=119)"),
  Stage_I = c("7.4%", "21.2%", "18.5%"),
  Stage_II = c("37.9%", "43.9%", "38.7%"),
  Stage_III = c("29.5%", "28.8%", "31.9%"),
  Stage_IV = c("25.3%", "6.1%", "10.9%"),
  P_value = c("0.0065**", "", ""),
  Key_Finding = c(
    "Highest Stage IV",
    "Lowest Stage IV (better prognosis)",
    "Intermediate"
  )
)

write.csv(stage_dist_ppt, 
          "04_External_Validation/tables/stage_distribution_ppt.csv",
          row.names = FALSE)

cat("âœ“ Stage distribution table (PPT format) saved\n")

################################################################################
# STEP 7: Clinical Visualizations
################################################################################

cat("Creating clinical feature visualizations...\n")

png("04_External_Validation/plots/clinical_features_by_cluster_2.png",
    width = 14, height = 6, units = "in", res = 300)

par(mfrow = c(1, 3), mar = c(5, 5, 4, 2))

# Age
boxplot(age_years ~ cluster, data = merged_data,
        col = c("#E69F00", "#56B4E9", "#009E73"),
        names = paste0("Cluster\n", 1:3),
        ylab = "Age at Diagnosis (years)",
        main = paste0("Age Distribution\n(p ", format.pval(age_test$p.value, digits = 2), ")"),
        border = "black",
        las = 1)
grid()

# Gender
gender_pct <- prop.table(gender_table, margin = 1) * 100
barplot(t(gender_pct),
        beside = TRUE,
        col = c("#FF00FF", "turquoise"),
        names.arg = paste0("Cluster ", 1:3),
        ylab = "Percentage (%)",
        main = paste0("Gender Distribution\n(p ", format.pval(gender_test$p.value, digits = 2), ")"),
        ylim = c(0, 100),
        border = "black",
        las = 1)
legend("topright", legend = c("Female", "Male"), 
       fill = c("#FF00FF", "turquoise"), border = "black")

# Remove "not reported" (1.9% gender missing values) column for cleaner visualization
#gender_table_clean <- gender_table[, c("female", "male")]
#gender_pct_clean <- prop.table(gender_table_clean, margin = 1) * 100

#barplot(t(gender_pct_clean),
#        beside = TRUE,
#        col = c("#FF00FF", "turquoise"),
#        names.arg = paste0("Cluster ", 1:3),
#        ylab = "Percentage (%)",
#        main = paste0("Gender Distribution\n(p ", format.pval(gender_test$p.value, digits = 2), ")"),
#        ylim = c(0, 100),
#        border = "black",
#        las = 1)
#legend("topright", legend = c("Female", "Male"), 
#       fill = c("#FF00FF", "turquoise"), border = "black")

# Stage
stage_pct <- prop.table(stage_table, margin = 1) * 100
barplot(t(stage_pct),
        beside = TRUE,
        col = c("#fee5d9", "#fcae91", "#fb6a4a", "#de2d26")[1:nrow(stage_pct)],
        names.arg = paste0("C", 1:3),
        ylab = "Percentage (%)",
        main = paste0("Tumor Stage\n(p ", format.pval(stage_test$p.value, digits = 2), ")"),
        ylim = c(0, max(stage_pct) * 1.2),
        border = "black",
        las = 1)
legend("topright", legend = rownames(stage_pct), 
       fill = c("#fee5d9", "#fcae91", "#fb6a4a", "#de2d26")[1:nrow(stage_pct)],
       border = "black", cex = 0.8)

par(mfrow = c(1, 1))
dev.off()

cat("âœ…  Clinical plots saved\n\n")

################################################################################
# STEP 8: Identify Cluster Identities
################################################################################

writeLines(c(
  "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
  "â•‘   CLUSTER IDENTITY DETERMINATION      â•‘",
  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
))

# Calculate enrichment by cluster
lynch_by_cluster <- tapply(merged_data$has_lynch_core, merged_data$cluster, mean, na.rm = TRUE)
braf_by_cluster <- tapply(merged_data$has_braf, merged_data$cluster, mean, na.rm = TRUE)
msi_by_cluster <- tapply(merged_data$has_msi_related, merged_data$cluster, mean, na.rm = TRUE)
kras_by_cluster <- tapply(merged_data$has_kras, merged_data$cluster, mean, na.rm = TRUE)

cat("Marker enrichment by cluster:\n\n")
for(cl in 1:3) {
  cat("Cluster", cl, ":\n")
  cat("  Lynch:", round(100*lynch_by_cluster[cl], 1), "%\n")
  cat("  BRAF:", round(100*braf_by_cluster[cl], 1), "%\n")
  cat("  MSI-High:", round(100*msi_by_cluster[cl], 1), "%\n")
  cat("  KRAS:", round(100*kras_by_cluster[cl], 1), "%\n\n")
}

# Identify clusters
lynch_cluster <- which.max(lynch_by_cluster)
braf_cluster <- which.max(braf_by_cluster)
sporadic_cluster <- setdiff(1:3, c(lynch_cluster, braf_cluster))

cat("PROPOSED CLUSTER IDENTITIES:\n")
cat(" âœ¨ Cluster", lynch_cluster, "â†’ LYNCH SYNDROME (", 
    round(100*lynch_by_cluster[lynch_cluster], 1), "% Lynch mutations)\n", sep="")
cat(" âœ¨ Cluster", braf_cluster, "â†’ CIMP-HIGH (", 
    round(100*braf_by_cluster[braf_cluster], 1), "% BRAF mutations)\n", sep="")
if(length(sporadic_cluster) == 1) {
  cat(" âœ¨ Cluster", sporadic_cluster, "â†’ SPORADIC/HETEROGENEOUS\n", sep="")
}

################################################################################
# STEP 8: FINAL SUMMARY
################################################################################

cat("KEY FINDINGS:\n\n")

cat("MOLECULAR MARKERS:\n")
cat("  âœ”ï¸ Lynch mutations: p =", format.pval(lynch_result$p_value), "\n")
cat("  âœ”ï¸ BRAF mutations: p =", format.pval(braf_result$p_value), "\n")
cat("  âœ”ï¸ MSI-High: p =", format.pval(msi_result$p_value), "\n")
cat("  âœ”ï¸ KRAS mutations: p =", format.pval(kras_result$p_value), "\n\n")

cat("CLINICAL FEATURES:\n")
cat("  âœ”ï¸ Age: p =", format.pval(age_test$p.value), "\n")
cat("  âœ”ï¸ Gender: p =", format.pval(gender_test$p.value), "\n")
cat("  âœ”ï¸ Stage: p =", format.pval(stage_test$p.value), "\n\n")

# Identify cluster identities based on markers
cat("CLUSTER INTERPRETATIONS:\n")

# Which cluster has highest Lynch %?
lynch_by_cluster <- tapply(merged_data$has_lynch_core, merged_data$cluster, mean, na.rm = TRUE)
lynch_cluster <- which.max(lynch_by_cluster)

# Which cluster has highest BRAF %?
braf_by_cluster <- tapply(merged_data$has_braf, merged_data$cluster, mean, na.rm = TRUE)
braf_cluster <- which.max(braf_by_cluster)

cat("  âœ”ï¸ Cluster", lynch_cluster, ": Highest Lynch mutations (", 
    round(100*lynch_by_cluster[lynch_cluster], 1), "%) - likely LYNCH SYNDROME\n", sep="")
cat("  âœ”ï¸ Cluster", braf_cluster, ": Highest BRAF mutations (", 
    round(100*braf_by_cluster[braf_cluster], 1), "%) - likely CIMP-HIGH\n", sep="")

# The remaining cluster
sporadic_cluster <- setdiff(1:3, c(lynch_cluster, braf_cluster))
if(length(sporadic_cluster) == 1) {
  cat("  âœ”ï¸ Cluster", sporadic_cluster, ": Lowest Lynch/BRAF - likely SPORADIC\n")
}

cat("\n")
cat("Files created:\n")
cat("  âœ”ï¸ merged_clusters_with_features.csv\n")
cat("  âœ”ï¸ molecular_markers_by_cluster.csv\n")
cat("  âœ”ï¸ molecular_markers_by_cluster.png\n")
cat("  âœ”ï¸ clinical_features_by_cluster.png\n")
cat("\n")

writeLines(c(
  "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
  "â•‘     ðŸ†  EXTERNAL VALIDATION COMPLETE  ðŸ†             â•‘",
  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
))

```
